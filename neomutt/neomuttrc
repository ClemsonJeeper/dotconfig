# === Core paths and identity ===
set realname = "Rob Johnston"
set mbox_type = Maildir
set folder = /data/rjohnst/Maildir
set tmpdir = ~/.cache/neomutt/temp
set attach_save_dir = "~/Downloads"
set hostname = "juniper.net"

# === Cache configuration ===
set header_cache = ~/.cache/neomutt/headers
set header_cache_backend = "lmdb"
set message_cachedir = ~/.cache/neomutt/messages

# === Editor ===
set edit_headers = yes
set editor = "~/.config/neomutt/neomutt_editor.sh %s"

# === Sending mail ===
set from = "rjohnst@juniper.net"
#set from = "robert.johnston@hpe.com"
set spoolfile = INBOX
#set sendmail = "/usr/bin/msmtp -a hpe"
#set envelope_from = yes
#unset envelope_from
set use_from = yes

# === Compose and reply behaviour ===
set compose_format = "-- NeoMutt: Compose [Approx. msg size: %l | Atts: %a]%>-"
set attribution = "On %{%a, %d %b %Y at %I:%M %p %Z}, %n wrote:"
set forward_format = "Fwd: %s"
set quote_regexp="^( {0,5}[>|:%]| {0,5}[a-z0-9]+[>|]+)+"

set reply_regexp="^((re(\\^[0-9])? ?:|a(nt)?w(ort)?:|wg:|\\(fwd\\))[ \t]*)*"
set fast_reply = yes
set include = yes
set forward_quote = yes
set reverse_name = yes
set reverse_alias = yes
# Use format=flowed for better plain text rendering
set text_flowed = yes
# Tab completion for addresses in compose mode
bind editor <Tab> complete-query
# Background sendmail process (don't wait for it to complete)
set sendmail_wait = -1

# === General behaviour ===
# Don't prompt "Press any key to continue" after shell commands
set wait_key = no
# No pause when displaying informational messages
set sleep_time = 0
set quit = ask-yes
set confirmappend = no
set confirmcreate = yes
set beep_new = no
set change_folder_next = yes
set mark_macro_prefix = "'"

# === Message management ===
# Actually delete messages marked for deletion on sync
set delete = yes
set delete_untag = no
set move = no
# Don't distinguish between 'new' and 'old unread' messages
set mark_old = no

# put a copy in =sent mail, the current folder, and also Bcc for Outlook
# fcc-hook . '=sent-mail,^'

set record = =sent-mail
unmy_hdr *
my_hdr Bcc: "Rob Johnston" <rjohnst@juniper.net>
my_hdr From: "Rob Johnston" <rjohnst@juniper.net>
# my_hdr Bcc: "Rob Johnston" <robert.johnston@hpe.com>
# my_hdr From: "Rob Johnston" <robert.johnston@hpe.com>

# === Search and filtering ===
set simple_search = "~f %s | ~t %s | ~c %s | ~s %s"
set thorough_search = yes
set pipe_decode = yes

# === Performance settings ===
set mail_check = 3
set mail_check_stats = yes
set mail_check_stats_interval = 3
set read_inc = 100
set write_inc = 100
set net_inc = 5
set save_history = 100
set history = 1000

# === Address lookup ===
set query_command = "mu cfind --format=mutt-ab '%s' 2>/dev/null | awk -F'\\t' '!seen[$1]++'"
set query_format = "%3c %t %-25.25n %-25.25a %?e?(%e)?"

# === Display and formatting ===
set date_format = "%d/%m/%y %H:%M"
set index_format = "%4C %Z %?X?A& ? %{%b %d} %-15.15L %?M?(#%03M)&(%5c)? %s"
set pager_format = "-%Z- %C/%m: %.20n   %s %* -- (%P)"
set attach_format = "[%D %t] %2n [%-7.7m/%10.10M] %.40d %> [%s] "
#set display_filter = "exec gsed -r \"s/^Date:\\s*(([F-Wa-u]{3},\\s*)?[[:digit:]]{1,2}\\s+[A-Sa-y]{3}\\s+[[:digit:]]{4}\\s+[[:digit:]]{1,2}:[[:digit:]]{1,2}(:[[:digit:]]{1,2})?\\s+[+-][[:digit:]]{4})/gdate +'Date: %a, %d %b %Y %H:%M:%S %z' -d '\\1'/e\""
set display_filter = "exec sed '/External Email/{N;/\\n$/d}'"
ignore *
unignore from date subject to cc organization organisation x-mailer: x-newsreader: x-mailing-list: posted-to:

# === Message sorting and threading ===
set sort = last-date
set use_threads = threads
set sort_aux = date
#set sort = threads
#set sort_aux = date

set sort_re = yes
set strict_threads = no
set hide_thread_subject = yes
set narrow_tree = no
set collapse_unread = no
set uncollapse_jump = yes

# === Pager settings ===
set pager_index_lines = 0
set pager_context = 0
set pager_stop = yes
set pager_read_delay = 0
set menu_scroll = no
set smart_wrap = yes
set tilde = yes
set markers = no

# === Sidebar configuration ===
set sidebar_visible = yes
set sidebar_width = 25
set sidebar_format = "%D%?F? [%F]?%* %?N?%N/?%S"
set sidebar_short_path = yes
set sidebar_delim_chars = "/"
set sidebar_folder_indent = no
set sidebar_indent_string = "  "
set sidebar_new_mail_only = no
set sidebar_sort_method = "unsorted"
set sidebar_component_depth = 1

# === Mailcap Configuration ===
set mailcap_path = ~/.config/neomutt/mailcap

# Automatically view HTML emails
auto_view text/html
auto_view text/calendar
auto_view application/ics

# Prefer plain text over HTML
alternative_order text/plain text/enriched text/html

# Use mailcap entries for viewing attachments
set implicit_autoview = yes

# === Mailboxes configuration ===
# Define these BEFORE sourcing account configs that change folder
unmailboxes *
set nm_default_uri="notmuch:///data/rjohnst/Maildir" # path to the maildir

virtual-mailboxes \
   "INBOX" "notmuch://?query=tag:inbox and NOT tag:archive" \
   "INBOX(RAW)" =inbox \
   "Unread" "notmuch://?query=tag:unread" \
   "Important" "notmuch://?query=tag:starred" \
   "TODO" "notmuch://?query=tag:todo" \
   "ui-hackers" "notmuch://?query=tag:ui-hackers" \
   "software-ui" "notmuch://?query=tag:software-ui" \
   "jira" "notmuch://?query=tag:jira" \
   "python-hackers" "notmuch://?query=tag:python-hackers" \
   "script-hackers" "notmuch://?query=tag:script-hackers" \
   "security-hackers" "notmuch://?query=tag:security-hackers" \
   "Archive" "notmuch://?query=tag:archive" \
   "2025" "notmuch://?query=date:2025" \
   "2024" "notmuch://?query=date:2024" \
   "2023" "notmuch://?query=date:2023" \
   "2022" "notmuch://?query=date:2022" \
   "Sent" "notmuch://?query=tag:sent" \

# === External configuration files ===
# Enable true color support (must be set before color commands)
#set color_directcolor = yes

source ~/.config/neomutt/aliases

# === Attachments configuration ===
set abort_noattach = ask-yes
set abort_noattach_regex = "\\<(attach|attached|attachments?|^attached|^attachment|(see|check) (attachments?|attached))\\>"
set forward_attachments = yes
set mime_forward = ask-no

# === Encryption (disabled) ===
set crypt_use_gpgme = no
set crypt_autosign = no
set crypt_opportunistic_encrypt = no

# ==============================
# === KEY BINDINGS AND MACROS ===
# ==============================

# === Vim-style navigation ===
bind pager g noop
bind pager gg top
bind pager G bottom
bind index g noop
bind index gg first-entry
bind index G last-entry
bind index,pager \Cj half-down
bind index,pager \Ck half-up
bind pager \CJ next-line
bind pager \CK previous-line
bind index,pager n next-entry
bind index,pager p previous-entry
bind index <space> next-page
bind index $ last-entry
bind index <up> previous-entry
bind index <down> next-entry
macro index \' "l ~F | ~U\r" "Show Important Mails"
bind pager <up> previous-line
bind pager <down> next-line
bind pager <left> previous-entry
bind pager <right> next-entry
bind pager i exit

# === Sidebar navigation ===
bind index <left> sidebar-prev
bind index <right> sidebar-next
bind index <space> sidebar-open
macro index,pager ,@) "<enter-command> set sidebar_visible=no; macro index,pager \\\` ,@( 'Toggle sidebar'<Enter>"
macro index,pager ,@( "<enter-command> set sidebar_visible=yes; macro index,pager \\\` ,@) 'Toggle sidebar'<Enter>"
macro index,pager  \` ,@) 'Toggle sidebar'

bind index i noop

# === Notmuch Bindings ===
macro index / "<vfolder-from-query>"              # looks up a hand made query
#macro index A "<modify-labels>+archive -unread -inbox\\n"        # tag as Archived
#macro index I "<modify-labels>-inbox -unread\\n"                 # removed from inbox
#macro index S "<modify-labels-then-hide>-inbox -unread +junk\n" # tag as Junk mail
#macro index * "<modify-labels>!starred<enter>" "Toggle Starred"               # tag as starred
macro index - "<flag-message>"
#macro index + "<flag-message><previous-entry><modify-labels>+starred<enter><sync-mailbox>"
#macro index - "<modify-labels>-starred\n<sync-mailbox>"               # tag as unstarred
macro index + "<modify-labels>!todo<enter>" "Toggle TODO"

# === Attachment navigation ===
bind attach n next-entry
bind attach p previous-entry

# === Search bindings ===
#macro index ? "<search-reverse>" "search backwards"
#macro index n "<search-next>" "next search result"
#macro index N "<search-opposite>" "previous search result"
macro index ,r "<change-folder-readonly>~/.mu/results<enter>" "mu results"

# === Sync operations ===
macro index,pager ,s "<shell-escape>mailsync<enter>" "sync all mail"

# Execute all pending operations
bind index,pager x sync-mailbox

# === Message management ===
bind index,pager r group-reply
macro index U "<toggle-new>" "toggle unread status"
bind index * flag-message
#bind index <space> tag-entry
#bind index <Esc><space> tag-thread
#bind index <Esc>t tag-pattern

# === Deletion workflow ===
bind index,pager d delete-message
bind index,pager u undelete-message
#macro index,pager dd "<delete-message>" "mark for deletion"
#macro index,pager dt "<delete-thread>" "mark thread for deletion"
bind index x sync-mailbox

# === Threading ===
bind index za collapse-thread
bind index zA collapse-all

# === Quick filters ===
macro index ,l "<limit>all<enter>" "remove limit"
macro index ,L "<limit>~U<enter>" "limit to unread in folder"
macro index ,t "<limit>~d <1w<enter>" "limit to this week"
macro index ,y "<limit>~d <1d<enter>" "limit to today"

# === URL and HTML handling ===
macro index,pager ,b "<pipe-message> urlview<enter>" "extract URLs with urlview"
macro attach,compose ,b "<pipe-entry> urlview<enter>" "extract URLs with urlview"

# === Sidebar settings ===
set sidebar_width   = 30
set sidebar_visible = yes               # set to "no" to disable sidebar view at startup
set sidebar_divider_char = '║'
color sidebar_new yellow default

set sidebar_format = "%D%?N?   %N?%?F?  %F?%* %S"

# === Colors ===
color normal	 default default	# normal text
color indicator	 brightwhite    blue    # actual message
color tree	 cyan		default	# thread arrows
color status	 brightcyan 	blue	# status line
color error	 brightred	default	# errors
color message	 brightred	default	# info messages
color signature	 red		black	# signature
color attachment cyan 		black	# MIME attachments
color search	 brightyellow	red	# search matches
color markers	 red		black	# + at beginning of wrapped lines
color hdrdefault brightblue	black	# black header lines
color bold	 red		black	# hiliting bold patterns in body
color underline	 green		black	# hiliting underlined patterns in body

uncolor index *					# unset all color index entries
color index	 brightwhite red   ~F		# Flagged
color index	 brightcyan  black   ~N		# New
color index	 magenta    default  ~T		# Tagged
color index	 yellow	    default  ~D		# Deleted
color index brightred black '~Ystarred'
color index black green '~Ytodo'

color header	 cyan	    black  "^(from|to|cc):"
color header     brightcyan black  "^(subject)"
color header     brightwhite      black  "^(date)"

color quoted	 cyan		default	# quoted text
color quoted1	 magenta	default
color quoted2	 red		default
color quoted3	 green		default
color quoted4	 cyan		default
color quoted5	 blue		default
color quoted6	 magenta	default
color quoted7	 red		default
color quoted8	 green		default
color quoted9	 cyan		default

color tilde	 brightmagenta	default	# ~ at bottom of msg

color body	 brightcyan default  "((ftp|http|https)://|(file|news):|www\\.)[-a-z0-9_.:]*[a-z0-9](/[^][{} \t\n\r\"<>()]*[^][{} \t\n\r\"<>().,:!])?/?"
color body	 cyan	    default  "[-a-z_0-9.+]+@[-a-z_0-9.]+"
color body	 red	    default  "(^| )\\*[-a-z0-9*]+\\*[,.?]?[ \n]"
color body	 green	    default  "(^| )_[-a-z0-9_]+_[,.?]?[ \n]"

source ~/.config/neomutt/plugins/neomutt-powerline-nerdfonts/powerline.neomuttrc

# === EOF ===
